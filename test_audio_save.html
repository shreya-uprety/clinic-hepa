<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedForce AI - Multi-Box Bench</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .json-box { height: 250px; overflow-y: auto; background: #000; border: 1px solid #1f2937; border-radius: 0.75rem; }
        pre { font-size: 10px; line-height: 1.2; padding: 10px; color: #10b981; tab-size: 2; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #374151; }
        .header-tag { font-size: 9px; font-weight: 800; letter-spacing: 0.05em; }
        .q-card { transition: transform 0.2s ease; border-left-width: 4px; }
        .q-card:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 p-4 font-sans min-h-screen">

    <!-- Top Navigation -->
    <header class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
        <div>
            <h1 class="text-2xl font-black text-blue-500">MedForce <span class="text-white">PROTOTYPE</span></h1>
            <div class="flex items-center gap-3 mt-1">
                <p id="systemState" class="text-gray-500 text-xs">Staggered Handshake Mode</p>
                <span id="byteCounter" class="text-[10px] font-mono text-emerald-500 bg-emerald-500/10 px-2 py-0.5 rounded">0 bytes relayed</span>
                <!-- Added Recording Indicator -->
                <span id="recIndicator" class="hidden text-[10px] font-mono text-red-500 bg-red-500/10 px-2 py-0.5 rounded animate-pulse">● REC</span>
            </div>
        </div>
        
        <div class="flex gap-4 items-center">
            <div class="flex flex-col items-end mr-4">
                <span class="text-[9px] text-gray-500 uppercase font-bold mb-1">Target Environment</span>
                <select id="serverSelect" class="bg-gray-900 text-xs text-blue-400 border border-gray-700 rounded px-2 py-1 outline-none focus:border-blue-500">
                    <option value="ws://localhost:8000">Local (localhost:8000)</option>
                    <option value="wss://clinic-hepa-v2-481780815788.europe-west1.run.app">Deployed (Google Cloud Run)</option>
                </select>
            </div>
            <button id="startBtn" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-bold text-sm transition-all active:scale-95 shadow-lg shadow-blue-900/20">Start Session</button>
            
            <!-- NEW DOWNLOAD BUTTON -->
            <button id="downloadBtn" onclick="downloadAudio()" disabled class="bg-emerald-700 hover:bg-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed px-4 py-2 rounded-lg font-bold text-sm transition text-white flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Download WAV
            </button>

            <button onclick="location.reload()" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg font-bold text-sm transition">Reset</button>
        </div>
    </header>

    <!-- Unasked Questions Section -->
    <section class="mb-8">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-xs font-black uppercase tracking-widest text-yellow-500 flex items-center gap-2">
                <span class="relative flex h-2 w-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-yellow-500"></span>
                </span>
                Priority Clinical Questions (Unasked)
            </h2>
            <span id="qCount" class="text-[10px] font-mono text-gray-500">0 Pending</span>
        </div>
        <div id="priorityQuestions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 min-h-[100px]">
            <div class="col-span-full py-10 border-2 border-dashed border-gray-800 rounded-2xl text-center text-gray-600 text-sm italic">
                Awaiting initial analysis...
            </div>
        </div>
    </section>

    <!-- Asked Questions Section -->
    <section class="mb-8">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-xs font-black uppercase tracking-widest text-emerald-500 flex items-center gap-2">
                <span class="inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                Completed Questions (Answered)
            </h2>
            <span id="askedCount" class="text-[10px] font-mono text-gray-500">0 Collected</span>
        </div>
        <div id="askedQuestions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 min-h-[50px]">
            <div class="col-span-full py-4 border border-gray-800 rounded-2xl text-center text-gray-600 text-xs italic">
                No questions answered yet.
            </div>
        </div>
    </section>

    <!-- Diagnosis Section -->
    <section class="mb-8">
        <div class="flex items-center justify-between mb-3">
            <h2 class="text-xs font-black uppercase tracking-widest text-blue-500 flex items-center gap-2">
                <span class="relative flex h-2 w-2">
                    <span class="animate-pulse absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                </span>
                Active Differential Diagnoses
            </h2>
            <span id="diagCount" class="text-[10px] font-mono text-gray-500">0 Identified</span>
        </div>
        <div id="priorityDiagnosis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 min-h-[100px]">
            <div class="col-span-full py-10 border-2 border-dashed border-gray-800 rounded-2xl text-center text-gray-600 text-sm italic">
                Awaiting clinical data...
            </div>
        </div>
    </section>

    <!-- Raw Data Grid -->
    <div class="header-tag text-gray-500 mb-4 border-t border-gray-800 pt-4 uppercase italic">● Raw System Streams</div>
    <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <section><div class="header-tag text-purple-500 mb-1 uppercase">● Chat Transcript</div><div class="json-box" id="box-chat"><pre>Waiting...</pre></div></section>
        <section><div class="header-tag text-blue-500 mb-1 uppercase">● Diagnosis Pool</div><div class="json-box" id="box-diagnosis"><pre>Waiting...</pre></div></section>
        <section><div class="header-tag text-yellow-500 mb-1 uppercase">● Question Pool</div><div class="json-box" id="box-questions"><pre>Waiting...</pre></div></section>
        <section><div class="header-tag text-pink-500 mb-1 uppercase">● Analytics</div><div class="json-box" id="box-analytics"><pre>Waiting...</pre></div></section>
        <section><div class="header-tag text-emerald-500 mb-1 uppercase">● Education</div><div class="json-box" id="box-education"><pre>Waiting...</pre></div></section>
        <section><div class="header-tag text-gray-400 mb-1 uppercase">● Status</div><div class="json-box" id="box-status"><pre>Waiting...</pre></div></section>
        <section><div class="header-tag text-orange-500 mb-1 uppercase">● Checklist</div><div class="json-box" id="box-checklist"><pre>Waiting...</pre></div></section>
        <section><div class="header-tag text-red-500 mb-1 uppercase">● Report</div><div class="json-box" id="box-report"><pre>Waiting...</pre></div></section>
    </main>

    <script>
        let simSocket, transSocket;
        let audioCtx;
        let nextStartTime = 0;
        let bytesTotal = 0;
        let audioChunks = []; // Store raw audio buffers here
        
        const SAMPLE_RATE = 24000;
        const startPayload = { "type": "start", "patient_id": "P0001", "gender": "Male" };
        const relevantTypes = ["chat", "diagnosis", "questions", "analytics", "status", "education", "checklist", "report"];

        function getServerUrl() { return document.getElementById('serverSelect').value; }

        async function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
            }
            if (audioCtx.state === 'suspended') await audioCtx.resume();
        }

        function base64ToBuffer(base64) {
            const bin = window.atob(base64);
            const bytes = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
            return bytes.buffer;
        }

        async function playAndSyncedRelay(buffer) {
            // 1. Capture audio data for download
            audioChunks.push(buffer);
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('recIndicator').classList.remove('hidden');

            await initAudio();
            // The buffer coming from Python is likely Int16 PCM
            const int16 = new Int16Array(buffer);
            const float32 = new Float32Array(int16.length);
            
            // Convert Int16 to Float32 for Web Audio API playback
            for (let i = 0; i < int16.length; i++) float32[i] = int16[i] / 32768.0;

            const audioBuffer = audioCtx.createBuffer(1, float32.length, SAMPLE_RATE);
            audioBuffer.getChannelData(0).set(float32);
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            if (nextStartTime < now) nextStartTime = now + 0.1;
            
            const scheduledPlayTime = nextStartTime;
            source.start(scheduledPlayTime);
            nextStartTime += audioBuffer.duration;

            const delayMs = Math.max(0, (scheduledPlayTime - now) * 1000);
            setTimeout(() => {
                if (transSocket && transSocket.readyState === WebSocket.OPEN) {
                    transSocket.send(buffer);
                    bytesTotal += buffer.byteLength;
                    document.getElementById('byteCounter').innerText = `${bytesTotal.toLocaleString()} bytes relayed`;
                }
            }, delayMs);
        }

        // --- NEW: WAV Audio Export Logic ---
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function downloadAudio() {
            if (audioChunks.length === 0) {
                alert("No audio data to download.");
                return;
            }

            // Calculate total length
            let totalLength = 0;
            audioChunks.forEach(chunk => totalLength += chunk.byteLength);

            // Create WAV buffer (44 byte header + data)
            const wavBuffer = new ArrayBuffer(44 + totalLength);
            const view = new DataView(wavBuffer);

            // 1. RIFF Chunk Descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + totalLength, true); // ChunkSize
            writeString(view, 8, 'WAVE');

            // 2. fmt Sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);       // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true);        // AudioFormat (1 = PCM)
            view.setUint16(22, 1, true);        // NumChannels (1 = Mono)
            view.setUint32(24, SAMPLE_RATE, true); // SampleRate
            view.setUint32(28, SAMPLE_RATE * 2, true); // ByteRate (SampleRate * NumChannels * BitsPerSample/8)
            view.setUint16(32, 2, true);        // BlockAlign (NumChannels * BitsPerSample/8)
            view.setUint16(34, 16, true);       // BitsPerSample (16 bits)

            // 3. data Sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, totalLength, true);

            // Write raw PCM data
            let offset = 44;
            audioChunks.forEach(chunk => {
                const tmp = new Uint8Array(chunk);
                new Uint8Array(wavBuffer).set(tmp, offset);
                offset += chunk.byteLength;
            });

            // Create Blob and trigger download
            const blob = new Blob([wavBuffer], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `medforce_session_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.wav`;
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }
        // --- END WAV Logic ---

        function renderQuestions(questions) {
            const unaskedContainer = document.getElementById('priorityQuestions');
            const askedContainer = document.getElementById('askedQuestions');

            // 1. Filter Unasked
            const unasked = (questions || []).filter(q => q.status === null).sort((a, b) => a.rank - b.rank);
            document.getElementById('qCount').innerText = `${unasked.length} Pending`;
            
            if (unasked.length > 0) {
                unaskedContainer.innerHTML = unasked.map(q => `
                    <div class="q-card bg-gray-900 border-gray-800 ${q.rank <= 3 ? 'border-l-red-500' : 'border-l-yellow-500'} p-4 rounded-xl shadow-lg">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[9px] bg-black/50 text-gray-400 px-2 py-0.5 rounded font-mono">RANK ${q.rank}</span>
                            <span class="text-[9px] text-yellow-600 font-bold uppercase">${q.domain}</span>
                        </div>
                        <h3 class="text-xs font-bold text-gray-100 mb-1">${q.headline || 'Query'}</h3>
                        <p class="text-[11px] text-gray-400 italic">"${q.content}"</p>
                    </div>
                `).join('');
            }

            // 2. Filter Asked
            const asked = (questions || []).filter(q => q.status === "asked");
            document.getElementById('askedCount').innerText = `${asked.length} Collected`;

            if (asked.length > 0) {
                askedContainer.innerHTML = asked.map(q => `
                    <div class="bg-gray-900 border border-gray-800 border-l-emerald-500 border-l-4 p-3 rounded-xl opacity-80">
                        <div class="flex justify-between mb-1">
                            <span class="text-[8px] text-emerald-500 font-bold uppercase tracking-widest">${q.domain}</span>
                            <span class="text-[8px] text-gray-600 font-mono">ID: ${q.qid}</span>
                        </div>
                        <h3 class="text-[10px] font-bold text-gray-300 mb-1">${q.content}</h3>
                        <div class="bg-black/40 p-2 rounded border border-gray-800">
                            <p class="text-[10px] text-emerald-400 font-medium">Ans: ${q.answer || 'Confirmed'}</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        function renderDiagnosis(diagnoses) {
            const container = document.getElementById('priorityDiagnosis');
            const severityOrder = { "High": 0, "Moderate": 1, "Low": 2, "Very Low": 3 };
            const sorted = (diagnoses || []).sort((a, b) => (severityOrder[a.severity] ?? 99) - (severityOrder[b.severity] ?? 99));
            document.getElementById('diagCount').innerText = `${sorted.length} Identified`;
            if (sorted.length === 0) return;

            container.innerHTML = sorted.map(d => {
                let color = "border-l-gray-500";
                let text = "text-gray-400";
                if (d.severity === "High") { color = "border-l-red-600"; text = "text-red-500"; }
                else if (d.severity === "Moderate") { color = "border-l-orange-500"; text = "text-orange-500"; }
                else if (d.severity === "Low") { color = "border-l-yellow-500"; text = "text-yellow-500"; }

                return `
                <div class="q-card bg-gray-900 border-gray-800 ${color} p-4 rounded-xl shadow-lg">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[9px] font-black uppercase ${text}">${d.severity}</span>
                        <span class="text-[10px] text-gray-500 font-mono">${Math.round((d.certainty || 0) * 100)}% Match</span>
                    </div>
                    <h3 class="text-sm font-bold text-gray-100 mb-1">${d.headline || d.condition || d.name}</h3>
                    <p class="text-[11px] text-gray-400 line-clamp-3">${d.diagnosis || d.rationale || ''}</p>
                </div>
                `;
            }).join('');
        }

        document.getElementById('startBtn').onclick = async () => {
            await initAudio();
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').innerText = "Connecting...";
            connectTranscriber();
        };

        function connectTranscriber() {
            const baseUrl = getServerUrl();
            transSocket = new WebSocket(`${baseUrl}/ws/transcriber`);
            transSocket.binaryType = "arraybuffer";
            transSocket.onopen = () => {
                transSocket.send(JSON.stringify(startPayload));
                document.getElementById('startBtn').innerText = "Session Live";
            };

            transSocket.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    
                    if (relevantTypes.includes(msg.type)) {
                        const box = document.getElementById(`box-${msg.type}`);
                        if (box) {
                            box.querySelector('pre').innerText = JSON.stringify(msg.diagnosis || msg.questions || msg.data || msg, null, 2);
                            if (msg.type === 'chat') box.scrollTop = box.scrollHeight;
                        }
                        if (msg.type === 'questions') renderQuestions(msg.questions);
                        if (msg.type === 'diagnosis') renderDiagnosis(msg.diagnosis || msg.data);
                    }

                    if (msg.source === 'initial_analysis' && !simSocket) {
                        connectSimulation();
                    }
                } catch (e) { console.error("Socket Error:", e); }
            };
        }

        function connectSimulation() {
            const baseUrl = getServerUrl();
            simSocket = new WebSocket(`${baseUrl}/ws/simulation`);
            simSocket.onopen = () => {
                simSocket.send(JSON.stringify(startPayload));
            };
            simSocket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'audio' && msg.data) {
                    playAndSyncedRelay(base64ToBuffer(msg.data));
                }
            };
        }
    </script>
</body>
</html>